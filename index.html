<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>anonymous://chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#050505;
  --panel:#0b0b0b;
  --border:#1f1f1f;
  --text:#e5e7eb;
  --muted:#6b7280;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:monospace}
#top{
  height:50px;background:#000;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;padding:0 15px
}
#chat{height:calc(100vh - 120px);overflow:auto;padding:15px}
.msg{margin-bottom:12px}
.name{font-size:11px;color:var(--muted)}
.text{padding:6px 8px;background:var(--panel);border:1px solid var(--border);border-radius:4px}
#input{
  height:70px;display:flex;gap:10px;padding:10px;border-top:1px solid var(--border)
}
input{flex:1;background:#000;border:1px solid var(--border);color:var(--text);padding:10px}
button{background:#000;border:1px solid var(--border);color:var(--text);padding:0 14px;cursor:pointer}
button:hover{background:#111}
#adminPanel{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:#000;border:1px solid var(--border);padding:20px;display:none;width:260px
}
.admin-btn{width:100%;margin-bottom:8px}
.del{color:var(--danger);cursor:pointer}
</style>
</head>

<body>

<div id="top">
  <div>anonymous://chat</div>
  <div id="adminBtn" style="cursor:pointer">‚öôÔ∏è</div>
</div>

<div id="chat"></div>

<div id="input">
  <input id="msg" placeholder="mesaj yaz">
  <button onclick="send()">send</button>
</div>

<div id="adminPanel">
  <h3>ADMIN</h3>
  <button class="admin-btn" onclick="clearChat()">üßπ T√ºm mesajlarƒ± sil</button>
  <button class="admin-btn" onclick="adminPanel.style.display='none'">Kapat</button>
</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://dhwqtanvouvonspqwawm.supabase.co",
  "ANON_KEY"
);

/* ===== USER ===== */
const names=["root","ghost","null","cipher","shadow","void"];
const username=names[Math.floor(Math.random()*names.length)]+"#"+Math.floor(Math.random()*900+100);
const room="global";

/* ===== STATE ===== */
let lastSend=0;
let isAdmin=false;

/* ===== DRAW ===== */
function draw(m){
  const d=document.createElement("div");
  d.className="msg";
  d.id="m"+m.id;
  d.innerHTML=`
    <div class="name">
      ${m.name} ¬∑ #${m.id}
      ${isAdmin?`<span class="del" onclick="del(${m.id})"> ‚úñ</span>`:""}
    </div>
    <div class="text">${m.text}</div>
  `;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ===== LOAD ===== */
async function load(){
  const {data}=await sb
    .from("messages")
    .select("*")
    .eq("room",room)
    .order("id");

  chat.innerHTML="";
  data.forEach(draw);
}

/* ===== SEND ===== */
async function send(){
  const v=msg.value.trim();
  if(!v) return;

  if(Date.now()-lastSend<2000) return alert("Yava≈üla");
  lastSend=Date.now();

  const {data,error}=await sb.from("messages").insert({
    room,
    name:username,
    text:v
  }).select().single();

  if(error){alert(error.message);return;}

  draw(data); // anƒ±nda g√∂ster
  msg.value="";
}

/* ===== REALTIME (SADECE Dƒ∞ƒûERLERƒ∞) ===== */
sb.channel("chat")
.on("postgres_changes",
  {event:"INSERT",schema:"public",table:"messages"},
  p=>{
    if(p.new.room===room && p.new.name!==username){
      draw(p.new);
    }
  }
)
.on("postgres_changes",
  {event:"DELETE",schema:"public",table:"messages"},
  p=>{
    const el=document.getElementById("m"+p.old.id);
    if(el) el.remove();
  }
)
.subscribe();

/* ===== ADMIN ===== */
adminBtn.onclick=()=>{
  const p=prompt("Admin ≈üifre:");
  if(p==="12345"){
    isAdmin=true;
    adminPanel.style.display="block";
    load();
  }
};

async function del(id){
  if(!isAdmin) return;
  await sb.from("messages").delete().eq("id",id);
}

async function clearChat(){
  if(!isAdmin) return;
  await sb.from("messages").delete().neq("id",0);
}

/* ===== AUTO DELETE (10 DK) ===== */
setInterval(async()=>{
  await sb.from("messages")
    .delete()
    .lt("created_at",new Date(Date.now()-10*60*1000).toISOString());
},60000);

/* ===== INIT ===== */
load();
</script>

</body>
</html>
