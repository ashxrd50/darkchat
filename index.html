<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>anonymous://chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  background: #050505;
  color: #ccc;
  font-family: monospace;
}

#top {
  height: 45px;
  background: #000;
  border-bottom: 1px solid #111;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 10px;
}

#chat {
  height: calc(100vh - 90px);
  overflow-y: auto;
  padding: 10px;
}

.msg {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
}

.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #111;
  border: 1px solid #222;
}

.user {
  color: #6cf;
}

#input {
  height: 45px;
  border-top: 1px solid #111;
  display: flex;
}

#input input {
  flex: 1;
  background: #000;
  border: none;
  color: #fff;
  padding: 10px;
  font-family: monospace;
}

#input button {
  width: 80px;
  background: #000;
  color: #6cf;
  border: 1px solid #111;
}
</style>
</head>

<body>

<div id="top">
  <span>anonymous://chat</span>
  <span id="admin">ADMIN</span>
</div>

<div id="chat"></div>

<div id="input">
  <input id="msg" placeholder="mesaj yaz">
  <button onclick="send()">send</button>
</div>

<script>
// üîê ANON KULLANICI
function getUser() {
  let u = localStorage.getItem("anon");
  if (!u) {
    u = {
      name: "anonim#" + Math.floor(1000 + Math.random() * 9000),
      avatar: Math.floor(Math.random() * 6),
      uid: crypto.randomUUID()
    };
    localStorage.setItem("anon", JSON.stringify(u));
  }
  return JSON.parse(localStorage.getItem("anon"));
}
const user = getUser();

// üîó SUPABASE
const supabase = supabase.createClient(
  "https://PROJECT_ID.supabase.co",
  "PUBLIC_ANON_KEY"
);

// üì• MESAJ √áEK
async function load() {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .order("id", { ascending: true });

  data.forEach(addMsg);
}
load();

// üì° REALTIME
supabase
  .channel("chat")
  .on("postgres_changes", {
    event: "INSERT",
    schema: "public",
    table: "messages"
  }, payload => {
    addMsg(payload.new);
  })
  .subscribe();

// ‚ûï MESAJ G√ñSTER
function addMsg(m) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `
    <div class="avatar"></div>
    <div>
      <div class="user">${m.username}</div>
      <div>${escape(m.text)}</div>
    </div>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// üöÄ G√ñNDER
async function send() {
  const text = msg.value.trim();
  if (!text) return;

  await supabase.from("messages").insert({
    username: user.name,
    avatar: user.avatar,
    uid: user.uid,
    text
  });

  msg.value = "";
}

// üõ°Ô∏è XSS
function escape(str) {
  return str.replace(/[&<>"']/g, m =>
    ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])
  );
}
</script>

</body>
</html>
